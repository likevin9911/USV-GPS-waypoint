<?xml version="1.0"?>
<launch>

  <!-- Kalman filter fusing imu and gps into combined odometry/tf -->
  <node ns="wamv/robot_localization" pkg="robot_localization" type="ekf_localization_node"
          name="ekf_localization" clear_params="false">
      <param name="sensor_timeout" value="2.0"/>
      <param name="two_d_mode" value="false"/>
      <param name="map_frame" value="map"/>
      <param name="odom_frame" value="wamv/odom"/>
      <param name="base_link_frame" value="wamv/base_link"/>
      <param name="world_frame" value="wamv/odom"/>
      <param name="publish_tf" value="true"/>
      <param name="frequency" value="60"/>
      <param name="imu0" value="/wamv/sensors/imu/imu/data"/>
      <!-- IMU measures orientation, angular velocity, and linear acceleration -->
      <rosparam param="imu0_config">[false, false, false,
                                     true,  true,  true,
                                     false,  false,  false,
                                     true,  true,  true,
                                     true,  true,  true]</rosparam>
      <param name="imu0_differential" value="false"/>
      <param name="imu0_remove_gravitational_acceleration" value="true"/>

      <param name="odom0" value="/wamv/robot_localization/odometry/gps"/>
      <!-- GPS only reliably measures absolute position -->
      <rosparam param="odom0_config">[true,  true,  true,
                                      false, false, false,
                                      false, false, false,
                                      false, false, false,
                                      false, false, false]</rosparam>
                                      
       <rosparam param="initial_estimate_covariance">[4.31174e+00, 1.52949e-01, 9.02967e-03, 3.50377e-04, 1.20624e-03, -1.86091e-04, 6.45826e+01, 1.60636e+00, -2.70049e-02, 5.95639e-03, -3.75935e-03, -1.43580e-04, -5.66188e-02, -1.11697e-02, 4.02590e-02, 
1.52949e-01, 4.11326e+00, 4.99468e-03, -1.50103e-04, -1.16424e-03, -7.29981e-06, -5.28856e+00, 6.40563e+01, -5.43955e-03, -1.17484e-03, -9.09812e-04, -4.54742e-05, -2.24717e-02, -1.53338e-02, -3.07318e-03, 
9.02967e-03, 4.99468e-03, 1.43845e-02, -3.97349e-05, 1.96951e-04, 3.10027e-06, -2.09042e-02, -4.28599e-02, 1.31621e-03, 3.03787e-05, 1.25023e-03, 3.53028e-06, -1.93838e-03, -4.03135e-04, -5.55004e-03, 
3.50377e-04, -1.50103e-04, -3.97349e-05, 3.85946e-05, 9.18617e-05, -1.37496e-07, -6.63895e-03, 1.96814e-03, -3.21391e-06, 1.57863e-05, 3.12177e-05, 6.55960e-09, -9.40758e-04, 9.08139e-05, -5.94553e-05, 
1.20624e-03, -1.16424e-03, 1.96951e-04, 9.18617e-05, 1.06929e-03, -9.22059e-07, -1.56296e-02, -1.51898e-02, -8.29223e-04, -3.32614e-06, 3.08515e-04, 6.37037e-08, -5.00507e-03, 9.97371e-04, -4.32566e-03, 
-1.86091e-04, -7.29981e-06, 3.10027e-06, -1.37496e-07, -9.22059e-07, 2.24692e-07, -4.99768e-04, 2.89816e-04, 3.95909e-06, -1.15669e-06, 1.93303e-06, 5.10334e-08, 1.28995e-05, 3.07783e-07, -1.56375e-06, 
6.45826e+01, -5.28856e+00, -2.09042e-02, -6.63895e-03, -1.56296e-02, -4.99768e-04, 2.03799e+03, -8.82702e+01, -4.92030e-02, 4.44865e-02, -6.80058e-02, -9.11447e-04, 8.34556e-02, 6.34268e-02, 2.23966e-01, 
1.60636e+00, 6.40563e+01, -4.28599e-02, 1.96814e-03, -1.51898e-02, 2.89816e-04, -8.82702e+01, 2.10169e+03, 2.62998e-01, 1.92563e-02, -8.77597e-02, 1.34496e-04, 1.98968e-02, -5.18177e-02, -1.17136e-01,
-2.70049e-02, -5.43955e-03, 1.31621e-03, -3.21391e-06, -8.29223e-04, 3.95909e-06, -4.92030e-02, 2.62998e-01, 3.80160e-02, 1.52417e-04, 2.40269e-04, 1.16244e-06, 6.11245e-03, 4.52357e-04, -3.72061e-03, 
5.95639e-03, -1.17484e-03, 3.03787e-05, 1.57863e-05, -3.32614e-06, -1.15669e-06, 4.44865e-02, 1.92563e-02, 1.52417e-04, 1.05816e-03, -1.73692e-04, -1.10512e-05, 2.37911e-04, 1.03566e-04, -6.36138e-04, 
-3.75935e-03, -9.09812e-04, 1.25023e-03, 3.12177e-05, 3.08515e-04, 1.93303e-06, -6.80058e-02, -8.77597e-02, 2.40269e-04, -1.73692e-04, 2.15798e-02, 3.62979e-05, -1.98982e-03, 4.41539e-04, -1.79549e-03, 
-1.43580e-04, -4.54742e-05, 3.53028e-06, 6.55960e-09, 6.37037e-08, 5.10334e-08, -9.11447e-04, 1.34496e-04, 1.16244e-06, -1.10512e-05, 3.62979e-05, 9.88085e-07, -2.95371e-06, -1.72766e-06, -4.46947e-06, 
-5.66188e-02, -2.24717e-02, -1.93838e-03, -9.40758e-04, -5.00507e-03, 1.28995e-05, 8.34556e-02, 1.98968e-02, 6.11245e-03, 2.37911e-04, -1.98982e-03, -2.95371e-06, 1.00411e-01, -7.93952e-03, -4.52459e-02, 
-1.11697e-02, -1.53338e-02, -4.03135e-04, 9.08139e-05, 9.97371e-04, 3.07783e-07, 6.34268e-02, -5.18177e-02, 4.52357e-04, 1.03566e-04, 4.41539e-04, -1.72766e-06, -7.93952e-03, 1.20146e-02, -5.88416e-03, 
4.02590e-02, -3.07318e-03, -5.55004e-03, -5.94553e-05, -4.32566e-03, -1.56375e-06, 2.23966e-01, -1.17136e-01, -3.72061e-03, -6.36138e-04, -1.79549e-03, -4.46947e-06, -4.52459e-02, -5.88416e-03, 1.78037e-01]</rosparam>

<!--                                                   x     y     z     r     p     y   x_dot  y_dot  z_dot  r_dot p_dot y_dot x_ddot y_ddot z_ddot-->
    <rosparam param="process_noise_covariance">       [1,   0,    0,    0,    0,    0,    0,     0,     0,     0,    0,    0,    0,    0,      0,
                                                      0,    1,  0,    0,    0,    0,    0,     0,     0,     0,    0,    0,    0,    0,      0,
                                                      0,    0,    10,    0,    0,    0,    0,     0,     0,     0,    0,    0,    0,    0,      0,
                                                      0,    0,    0,    0.03, 0,    0,    0,     0,     0,     0,    0,    0,    0,    0,      0,
                                                      0,    0,    0,    0,    0.03, 0,    0,     0,     0,     0,    0,    0,    0,    0,      0,
                                                      0,    0,    0,    0,    0,    0.1,  0,     0,     0,     0,    0,    0,    0,    0,      0,
                                                      0,    0,    0,    0,    0,    0,    0.25,  0,     0,     0,    0,    0,    0,    0,      0,
                                                      0,    0,    0,    0,    0,    0,    0,     0.25,  0,     0,    0,    0,    0,    0,      0,
                                                      0,    0,    0,    0,    0,    0,    0,     0,     0.04,  0,    0,    0,    0,    0,      0,
                                                      0,    0,    0,    0,    0,    0,    0,     0,     0,     0.01, 0,    0,    0,    0,      0,
                                                      0,    0,    0,    0,    0,    0,    0,     0,     0,     0,    0.01, 0,    0,    0,      0,
                                                      0,    0,    0,    0,    0,    0,    0,     0,     0,     0,    0,    0.5,  0,    0,      0,
                                                      0,    0,    0,    0,    0,    0,    0,     0,     0,     0,    0,    0,    0.01, 0,      0,
                                                      0,    0,    0,    0,    0,    0,    0,     0,     0,     0,    0,    0,    0,    0.01,   0,
                                                      0,    0,    0,    0,    0,    0,    0,     0,     0,     0,    0,    0,    0,    0,      0.015]</rosparam>

      <param name="odom0_differential" value="false"/>
      <param name="smooth_lagged_data" value="true"/>
      <param name="transform_time_offset" value="0.1"/> <!-- Stops tf warnings -->
  </node>

  <!-- Produces local odometry from GPS to be used in Kalman filter -->
  <node ns="wamv/robot_localization" pkg="robot_localization" type="navsat_transform_node"
          name="navsat_transform_node" respawn="true" output="screen">
      <param name="tf_prefix" value="wamv" />
      <param name="frequency" value="60"/>
      <param name="magnetic_declination_radians" value="0"/>
      <param name="broadcast_utm_transform" value="true"/>
      <param name="wait_for_datum" value="true"/>
      <param name="use_odometry_yaw" value="true"/>
      <rosparam param="datum">[21.30996, -157.8901]</rosparam>
      <param name="yaw_offset" value="0"/>
      <param name="publish_filtered_gps" value="true"/>
      <remap to="/wamv/sensors/gps/gps/fix" from="/wamv/robot_localization/gps/fix" />
  </node>

  <group ns = "wamv">
    <node name="odom_relay" pkg="topic_tools" type="relay" args="robot_localization/odometry/filtered odom"/>
    <node name="robot_state_publisher" pkg="robot_state_publisher" type="robot_state_publisher">
      <param name="publish_frequency" value="60"/>
      <param name="tf_prefix" value="wamv"/>
    </node>
    <node name="wamv_tf_expander" pkg="vrx_navigation" type="wamv_tf_expander.py" />


  </group>

</launch>
